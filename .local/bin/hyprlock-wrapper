BRIGHTNESS_FILE="${XDG_RUNTIME_DIR:-/tmp}/hyprlock-brightness.txt"
PLAYERS_FILE="${XDG_RUNTIME_DIR:-/tmp}/hyprlock-playing-players.txt"

notify_user() {
    local summary="$1" body="$2" urgency="${3:-low}" timeout="${4:-2000}"
    notify-send --app-name="Hyprlock" --urgency="$urgency" --expire-time="$timeout" "$summary" "$body"
}

# --- Backlight fonksiyonlarÄ± (Ã–NEMLÄ°: Bu fonksiyonlarÄ±n TAM iÃ§eriÄŸini buraya eklemelisiniz.) ---
# EÄŸer bu fonksiyonlar dÄ±ÅŸarÄ±dan yÃ¼klenmiyorsa, tanÄ±mlÄ± olmalarÄ± gerekir.
# Ã–RNEK:
find_backlight() {
    # Bu fonksiyon, kullanÄ±lan arka Ä±ÅŸÄ±k aygÄ±tÄ±nÄ± bulmalÄ±dÄ±r
    echo $(ls -1 /sys/class/backlight/ | head -n 1) 
}

get_brightness_percent() {
    DEVICE=$(find_backlight)
    if [ -z "$DEVICE" ]; then echo 100; return; fi
    MAX=$(cat /sys/class/backlight/$DEVICE/max_brightness)
    NOW=$(cat /sys/class/backlight/$DEVICE/actual_brightness)
    echo $((NOW * 100 / MAX))
}

set_brightness_percent() {
    local percent=$1
    DEVICE=$(find_backlight)
    if [ -z "$DEVICE" ]; then return; fi
    MAX=$(cat /sys/class/backlight/$DEVICE/max_brightness)
    TARGET=$((MAX * percent / 100))
    brightnessctl -d $DEVICE set $TARGET
}
# --- Backlight fonksiyonlarÄ± sonu ---

get_players() { playerctl --list-all 2>/dev/null |
grep -v '^$'; }
is_player_playing() { [[ "$(playerctl -p "$1" status 2>/dev/null)" == "Playing" ]];
}

# ðŸ” Hypridleâ€™Ä± sÄ±fÄ±rla (idle sÃ¼resini resetler)
reset_hypridle() {
    # DPMS'i geÃ§ici olarak kapatÄ±p aÃ§mak yerine, ekranÄ± sadece uyandÄ±rÄ±yoruz (dpms on)
    hyprctl dispatch dpms on 2>/dev/null || true
    sleep 0.1
    # hyprctl dispatch dpms off 2>/dev/null || true  # Bu satÄ±r artÄ±k gerekli deÄŸil/Ã¶nerilmiyor
}

# â€”â€”â€”â€” 1. DurumlarÄ± kaydet â€”â€”â€”â€”
{
    brightness_now=$(get_brightness_percent) && echo "$brightness_now" > "$BRIGHTNESS_FILE"
    > "$PLAYERS_FILE"
    while IFS= read -r player;
do
        is_player_playing "$player" && echo "$player" >> "$PLAYERS_FILE"
    done < <(get_players)
} &>/dev/null

# â€”â€”â€”â€” 2. Kilit Ã¶ncesi â€”â€”â€”â€”
{
    # ðŸŒ™ ParlaklÄ±ÄŸÄ± dÃ¼ÅŸÃ¼r
    [[ -f "$BRIGHTNESS_FILE" ]] && set_brightness_percent 10

    # â¸ï¸ MedyayÄ± durdur
    while IFS= read -r player;
do playerctl -p "$player" pause 2>/dev/null; done < <(get_players)
    [ -S /tmp/mpvsocket ] && echo '{ "command": ["set", "pause", true] }' |
socat - /tmp/mpvsocket 2>/dev/null

    # ðŸ”” Bildirim
    notify_user "ðŸŒ™ðŸ”’ Kilitleniyor" "Medya durduruldu, parlaklÄ±k dÃ¼ÅŸÃ¼rÃ¼ldÃ¼."
"normal" 2000

    # ðŸ”„ Hypridleâ€™Ä± sÄ±fÄ±rla â€” BU Ã–NEMLÄ°!
reset_hypridle
} &>/dev/null

# â€”â€”â€”â€” 3. AsÄ±l kilit â€”â€”â€”â€”
hyprlock  # timeout kaldÄ±rÄ±ldÄ±;
# Ã§Ã¼nkÃ¼ hypridle zaman yÃ¶netimi Ã¼stleniyor

# â€”â€”â€”â€” 4. Kilidi aÃ§Ä±nca â€”â€”â€”â€”
{
    # ðŸŒž ParlaklÄ±k & medya geri
    [[ -f "$BRIGHTNESS_FILE" ]] && { set_brightness_percent "$(cat "$BRIGHTNESS_FILE")";
rm -f "$BRIGHTNESS_FILE"; }
    restarted=0
    [[ -s "$PLAYERS_FILE" ]] && {
        while IFS= read -r player;
do
            playerctl -p "$player" status &>/dev/null && playerctl -p "$player" play 2>/dev/null && ((restarted++))
        done < "$PLAYERS_FILE"
        rm -f "$PLAYERS_FILE"
    }

    # ðŸ’¡ EkranÄ± tekrar aÃ§:
    hyprctl dispatch dpms on 2>/dev/null || true

    # ðŸ”” Bildirim
    if (( restarted > 0 ));
then
        notify_user "ðŸŒžðŸ”Š Devam Ediyor" "ParlaklÄ±k ve $restarted oynatÄ±cÄ± geri yÃ¼klendi."
else
        notify_user "ðŸŒž ParlaklÄ±k geri yÃ¼klendi" ""
    fi
} &>/dev/null
